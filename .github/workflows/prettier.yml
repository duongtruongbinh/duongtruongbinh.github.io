name: Prettier Code Formatter

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Setup Node.js with Cache âš™ï¸
        uses: actions/setup-node@v4
        with:
          # Chá»n phiÃªn báº£n Node.js phÃ¹ há»£p vá»›i dá»± Ã¡n cá»§a báº¡n
          node-version: "20"
          # Tá»± Ä‘á»™ng cache cÃ¡c dependencies Ä‘á»ƒ cháº¡y nhanh hÆ¡n
          cache: "npm"

      - name: Install Dependencies ğŸ’¾
        # DÃ¹ng 'npm ci' thay vÃ¬ 'npm install'. NÃ³ nhanh vÃ  an toÃ n hÆ¡n cho CI
        # vÃ  Ä‘áº£m báº£o cÃ i Ä‘Ãºng cÃ¡c phiÃªn báº£n trong package-lock.json.
        run: npm ci

      - name: Prettier Check ğŸ”
        id: prettier
        run: npx prettier . --check

      - name: Create Diff on Failure ğŸ“
        if: failure()
        run: |
          # Cháº¡y write Ä‘á»ƒ táº¡o ra cÃ¡c thay Ä‘á»•i
          npx prettier . --write
          # Táº¡o file diff, bá» qua package.json vÃ  package-lock.json
          git diff -- . ':(exclude)package-lock.json' ':(exclude)package.json' > diff.txt
          # DÃ¹ng npx Ä‘á»ƒ cháº¡y diff2html mÃ  khÃ´ng cáº§n cÃ i global
          npx diff2html-cli -i file -s side -F diff.html -- diff.txt

      - name: Upload HTML Diff â¬†ï¸
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: HTML Diff
          path: diff.html
          retention-days: 7

      # BÆ°á»›c nÃ y báº¡n cÃ³ thá»ƒ giá»¯ nguyÃªn náº¿u Ä‘ang sá»­ dá»¥ng
      - name: Dispatch Information to Repository ğŸ—£ï¸
        if: failure() && github.event_name == 'pull_request'
        uses: peter-evans/repository-dispatch@v2
        with:
          event-type: prettier-failed-on-pr
          client-payload: '{"pr_number": "${{ github.event.number }}", "artifact_url": "${{ steps.artifact-upload.outputs.artifact-url }}", "run_id": "${{ github.run_id }}"}'
